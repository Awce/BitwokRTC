<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Chat - BitwokRTC</title>
    <style>
      /* Estilos generales */
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #202124;
        color: #e8eaed;
        display: flex;
        height: 100vh;
      }

      #mainContainer {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
      }

      /* Contenedor de video */
      #videoSection {
        flex-grow: 2;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        background-color: #202124;
      }

      #videoGrid {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        width: 100%;
        height: 100%;
        padding: 5px;
      }

      video {
        width: 40%;
        height: auto;
        border-radius: 10px;
        background-color: #000;
      }

      /* Controles de llamada */
      #controls {
        position: absolute;
        bottom: 20px;
        display: flex;
        justify-content: center;
        width: 100%;
      }

      .control-btn {
        background-color: #3c4043;
        border: none;
        color: #fff;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      .control-btn:hover {
        background-color: #5f6368;
      }

      .control-btn i {
        font-size: 18px;
        margin-right: 8px;
      }

      /* Chat */
      #chatSection {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #171717;
        border-left: 1px solid #3c4043;
        padding: 15px;
      }

      #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background-color: #202124;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      #messages p {
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
        background-color: #3c4043;
        color: #e8eaed;
        max-width: 100%;
        word-wrap: break-word;
        align-self: flex-end;
      }

      #messages p.you {
        background-color: #1a73e8;
        align-self: flex-start;
        text-align: right;
      }

      #messageInput {
        display: flex;
        gap: 10px;
      }

      input[type="text"] {
        flex-grow: 1;
        padding: 10px;
        border-radius: 50px;
        border: none;
        background-color: #3c4043;
        color: #fff;
        outline: none;
      }

      button {
        padding: 10px 20px;
        background-color: #1a73e8;
        border: none;
        border-radius: 50px;
        color: #fff;
        cursor: pointer;
      }

      button:hover {
        background-color: #135bbd;
      }

      /* Responsividad */
      @media (max-width: 768px) {
        #videoGrid {
          flex-direction: column;
        }

        video {
          width: 90%;
        }

        #chatSection {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="mainContainer">
      <!-- Sección de video -->
      <div id="videoSection">
        <img src="./bitwokblanco.png" alt="logo" width="155" height="62.67" />
        <div id="videoGrid">
          <video id="localVideo" autoplay playsinline muted></video>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <!-- Controles -->
        <div id="controls">
          <button class="control-btn" id="toggleMic">
            <i class="fa fa-microphone"></i> Micrófono
          </button>
          <button class="control-btn" id="toggleCamera">
            <i class="fa fa-video"></i> Cámara
          </button>
          <button
            class="control-btn"
            id="endCall"
            style="background-color: red"
          >
            <i class="fa fa-phone"></i> Finalizar
          </button>
        </div>
      </div>

      <!-- Sección de chat -->
      <div id="chatSection">
        <div id="messages"></div>
        <div id="messageInput">
          <input type="text" id="message" placeholder="Escribe un mensaje..." />
          <button id="sendButton">Enviar</button>
        </div>
      </div>
    </div>

    <script
      src="https://kit.fontawesome.com/444872c563.js"
      crossorigin="anonymous"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      let localStream;
      let peerConnection;
      const configuration = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");

      // Variables para el estado del micrófono y cámara
      let isMicMuted = false;
      let isCameraOff = false;

      // Manejo de video y audio
      async function startCall() {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        localVideo.srcObject = localStream;

        peerConnection = new RTCPeerConnection(configuration);
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("signal", { signal: event.candidate });
          }
        };

        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };

        localStream
          .getTracks()
          .forEach((track) => peerConnection.addTrack(track, localStream));
      }

      socket.on("signal", (data) => {
        if (data.signal.type === "offer") {
          peerConnection.setRemoteDescription(
            new RTCSessionDescription(data.signal)
          );
          peerConnection.createAnswer().then((answer) => {
            peerConnection.setLocalDescription(answer);
            socket.emit("signal", { signal: answer });
          });
        } else if (data.signal.type === "answer") {
          peerConnection.setRemoteDescription(
            new RTCSessionDescription(data.signal)
          );
        } else if (data.signal.candidate) {
          peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
        }
      });

      // Inicia la videollamada
      startCall();

      // Manejo del chat
      const messageInput = document.getElementById("message");
      const sendButton = document.getElementById("sendButton");
      const messagesDiv = document.getElementById("messages");

      sendButton.addEventListener("click", () => {
        const message = messageInput.value;
        if (message) {
          socket.emit("chatMessage", message);
          addMessageToChat("Tú", message, "you");
          messageInput.value = "";
        }
      });

      socket.on("chatMessage", (data) => {
        addMessageToChat("Otro", data);
      });

      function addMessageToChat(user, message, className = "") {
        const messageElement = document.createElement("p");
        messageElement.textContent = `${user}: ${message}`;
        if (className) messageElement.classList.add(className);
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Funcionalidad de botones (micrófono, cámara y finalizar)
      document.getElementById("toggleMic").addEventListener("click", () => {
        localStream.getAudioTracks()[0].enabled =
          !localStream.getAudioTracks()[0].enabled;
        isMicMuted = !isMicMuted;
        document.getElementById("toggleMic").innerHTML = isMicMuted
          ? '<i class="fa fa-microphone-slash"></i> Micrófono'
          : '<i class="fa fa-microphone"></i> Micrófono';
      });

      document.getElementById("toggleCamera").addEventListener("click", () => {
        localStream.getVideoTracks()[0].enabled =
          !localStream.getVideoTracks()[0].enabled;
        isCameraOff = !isCameraOff;
        document.getElementById("toggleCamera").innerHTML = isCameraOff
          ? '<i class="fa fa-video-slash"></i> Cámara'
          : '<i class="fa fa-video"></i> Cámara';
      });

      document.getElementById("endCall").addEventListener("click", () => {
        peerConnection.close();
        localStream.getTracks().forEach((track) => track.stop());
        window.location.reload(); // Recarga la página para simular la finalización
      });
    </script>
  </body>
</html>
